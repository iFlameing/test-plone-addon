/**
 * Original source: https://github.com/udecode/slate-plugins/blob/next/packages/slate-plugins/src/serializers/serialize-html/serializeHTMLFromNodes.ts
 */

import React from 'react';
import { renderToStaticMarkup } from 'react-dom/server';
import { Text as SlateText } from 'slate';
import { Element as EditorElement, Leaf as EditorLeaf } from '../editor/render';

// let jsdom;
// if (typeof DOMParser === 'undefined') {
//   jsdom = require('jsdom');
// }

// Remove extra whitespace generated by ReactDOMServer
const trimWhitespace = (rawHtml) => rawHtml.replace(/(\r\n|\n|\r|\t)/gm, '');

// Remove redundant data attributes
const stripSlateDataAttributes = (rawHtml) =>
  rawHtml
    .replace(/( data-slate)(-node|-type)="[^"]+"/gm, '')
    .replace(/( data-testid)="[^"]+"/gm, '');

// TODO: We might also want to remove generated classes in the future.

const getNode = (elementProps) => {
  const element = <EditorElement {...elementProps} />;
  return renderToStaticMarkup(element);
};

const getLeaf = (leafProps) => {
  const leaf = <EditorLeaf {...leafProps} />;
  return renderToStaticMarkup(leaf);
};

// function htmlDecode(input) {
//   // on the server;
//   if (typeof DOMParser === 'undefined') {
//     const dom = new jsdom.JSDOM(input);
//     return dom.window.document.textContent;
//   }

//   // on the browser:
//   var doc = new DOMParser().parseFromString(input, 'text/html');
//   return doc.documentElement.textContent;
// }

/**
 *
 * @param plugins
 */
const serializeHTMLFromNodes = (plugins) => (nodes) => {
  const result = nodes
    .map((node) => {
      if (SlateText.isText(node)) {
        return getLeaf(
          {
            leaf: node,
            text: node,
            children: node.text,
            attributes: { 'data-slate-leaf': true },
          },
          plugins,
        );
      }
      return getNode(
        {
          element: node,
          children: encodeURIComponent(
            serializeHTMLFromNodes(plugins)(node.children),
          ),
          attributes: { 'data-slate-node': 'element', ref: null },
        },
        plugins,
      );
    })
    .join('');

  let r = stripSlateDataAttributes(trimWhitespace(decodeURIComponent(result)));
  // console.log('r', { r });
  return r;
};

export default serializeHTMLFromNodes;
